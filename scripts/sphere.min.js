function Photosphere(a){this.image=a}Photosphere.prototype.loadPhotosphere=function(a){a.innerHTML="<div class='preloader-wrapper big active load-sphere'><div class='spinner-layer spinner-orange-only'><div class='circle-clipper left'><div class='circle'></div></div><div class='gap-patch'><div class='circle'></div></div><div class='circle-clipper right'><div class='circle'></div></div></div></div>",this.holder=a,this.canUseCanvas()?(self=this,this.loadEXIF(function(){self.cropImage()})):a.innerHTML="<div style='width:100%;height:100%;overflow-x:scroll;overflow-y:hidden'><div style='margin: 10px; background: #ddd; opacity: 0.6; width: 300px; height: 20px; padding: 4px; position: relative'>If you upgrade to a better browser this is 3D!</div><img style='height:100%;margin-top: -48px' src='"+this.image+"' /></div>"},Photosphere.prototype.canUseCanvas=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},Photosphere.prototype.cropImage=function(){var a=new Image,b=this;a.onload=function(){var c=document.createElement("canvas");if(c.width=b.exif.full_width,c.height=b.exif.full_height,void 0!=this.maxSize&&(this.maxSize<c.width||this.maxSize<c.height)){var d=this.maxSize/c.width,e=this.maxSize/c.height;d*height<this.maxSize?(c.height=Math.ceil(d*height),c.width=this.maxSize):(c.width=Math.ceil(e*width),c.height=this.maxSize)}var f=c.getContext("2d");f.fillStyle="#000",f.fillRect(0,0,c.width,c.height),f.drawImage(a,b.exif.x/b.exif.full_width*c.width,b.exif.y/b.exif.full_height*c.height,b.exif.crop_width/b.exif.full_width*c.width,b.exif.crop_height/b.exif.full_height*c.height),b.start3D(c.toDataURL("image/png"))},a.src=this.image},Photosphere.prototype.canDoWebGL=function(){var a,b,c;try{a=document.createElement("canvas"),b=a.getContext("webgl")||a.getContext("experimental-webgl"),c=b.getSupportedExtensions()}catch(d){return!1}return void 0===b?!1:!0},Photosphere.prototype.start3D=function(a){if(void 0==window.THREE&&alert("Please make sure three.js is loaded"),this.target=new THREE.Vector3,this.lat=0,this.lon=90,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.isUserInteracting=!1,this.onMouseDownLon=0,this.onMouseDownLat=0,this.camera=new THREE.PerspectiveCamera(65,parseInt(this.holder.offsetWidth)/parseInt(this.holder.offsetHeight),1,1100),this.scene=new THREE.Scene,mesh=new THREE.Mesh(new THREE.SphereGeometry(256,64,64),this.loadTexture(a)),mesh.scale.x=-1,this.scene.add(mesh),console.log(this.canDoWebGL()),this.canDoWebGL())try{this.renderer=new THREE.WebGLRenderer,this.maxSize=this.renderer.context.getParameter(this.renderer.context.MAX_TEXTURE_SIZE)}catch(b){this.renderer=new THREE.CanvasRenderer}else this.renderer=new THREE.CanvasRenderer;this.renderer.setSize(parseInt(this.holder.offsetWidth),parseInt(this.holder.offsetHeight)),this.holder.innerHTML="",this.holder.appendChild(this.renderer.domElement),self=this,this.holder.addEventListener("touchstart",function(a){self.onDocumentTouchStart(a,self)},!1),this.holder.addEventListener("touchmove",function(a){self.onDocumentTouchMove(a,self)},!1),this.holder.addEventListener("mousedown",function(a){self.onDocumentMouseDown(a,self)},!1),this.holder.addEventListener("mousewheel",function(a){self.onMouseWheel(a,self)},!1),document.addEventListener("mousemove",function(a){self.onDocumentMouseMove(a,self)},!1),document.addEventListener("mouseup",function(a){self.onDocumentMouseUp(a,self)},!1),this.resetTimer(this,3e3)},Photosphere.prototype.startMoving=function(){self=this,this.interval=setInterval(function(){self.lon=self.lon-.1,-3<self.lat&&self.lat<3||(self.lat>10?self.lat-=.1:self.lat>0?self.lat-=.04:self.lat<0&&self.lat>10?self.lat+=.1:self.lat<0&&(self.lat+=.04)),self.render()},10)},Photosphere.prototype.resetTimer=function(a,b){void 0!=a.timer&&clearTimeout(a.timer),void 0!=a.interval&&clearInterval(a.interval),a.timer=setTimeout(function(){a.startMoving()},b)},Photosphere.prototype.onWindowResize=function(a){a.camera.aspect=parseInt(a.holder.offsetWidth)/parseInt(a.holder.offsetHeight),a.camera.updateProjectionMatrix(),a.renderer.setSize(parseInt(a.holder.offsetWidth),parseInt(a.holder.offsetHeight)),a.render()},Photosphere.prototype.onMouseWheel=function(a,b){proposed=b.camera.fov-.05*a.wheelDeltaY,proposed>10&&proposed<100&&(b.camera.fov=proposed,b.camera.updateProjectionMatrix(),b.render(),a.preventDefault())},Photosphere.prototype.onDocumentMouseDown=function(a,b){a.preventDefault(),b.isUserInteracting=!0,b.onPointerDownPointerX=a.clientX,b.onPointerDownPointerY=a.clientY,b.onPointerDownLon=b.lon,b.onPointerDownLat=b.lat},Photosphere.prototype.onDocumentMouseMove=function(a,b){b.isUserInteracting&&(b.lon=.1*(b.onPointerDownPointerX-a.clientX)+b.onPointerDownLon,b.lat=.1*(a.clientY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.resetTimer(b,9e3))},Photosphere.prototype.onDocumentTouchStart=function(a,b){1==a.touches.length&&(a.preventDefault(),b.onPointerDownPointerX=a.touches[0].pageX,b.onPointerDownPointerY=a.touches[0].pageY,b.onPointerDownLon=lon,b.onPointerDownLat=lat)},Photosphere.prototype.onDocumentTouchMove=function(a,b){1==a.touches.length&&(a.preventDefault(),b.lon=.1*(b.onPointerDownPointerX-a.touches[0].pageX)+b.onPointerDownLon,b.lat=.1*(a.touches[0].pageY-b.onPointerDownPointerY)+b.onPointerDownLat,b.render(),b.resetTimer(b,9e3))},Photosphere.prototype.onDocumentMouseUp=function(a,b){b.isUserInteracting=!1,b.render()},Photosphere.prototype.loadTexture=function(a){var b=new THREE.Texture,c=new THREE.MeshBasicMaterial({map:b,overdraw:!0}),d=new Image;return self=this,d.onload=function(){b.needsUpdate=!0,c.map.image=this,setTimeout(function(){self.render()},100)},d.src=a,c},Photosphere.prototype.render=function(){this.lat=Math.max(-85,Math.min(85,this.lat)),phi=(90-this.lat)*Math.PI/180,theta=this.lon*Math.PI/180,this.target.x=500*Math.sin(phi)*Math.cos(theta),this.target.y=500*Math.cos(phi),this.target.z=500*Math.sin(phi)*Math.sin(theta),this.camera.lookAt(this.target),this.renderer.render(this.scene,this.camera)},Photosphere.prototype.loadBinary=function(a){if(void 0!=this.binary_data)return void a(this.binary_data);var b=null;window.ActiveXObject?b=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(b=new XMLHttpRequest),"undefined"!=typeof b.onload?b.onload=function(){"200"==b.status&&a(b.responseText),b=null}:b.onreadystatechange=function(){4==b.readyState&&("200"==b.status&&a(b.responseText),b=null)},b.open("GET",this.image,!0),b.send(null)},Photosphere.prototype.setEXIF=function(a){return this.exif=a,this},Photosphere.prototype.loadEXIF=function(a){return void 0!=this.exif?void a():(self=this,void this.loadBinary(function(b){xmpEnd="</x:xmpmeta>",xmpp=b.substring(b.indexOf("<x:xmpmeta"),b.indexOf(xmpEnd)+xmpEnd.length),getAttr=function(a){return x=xmpp.indexOf(a)+a.length,s=xmpp.substring(x),s.match(/[0-9]+/)},self.exif={full_width:getAttr("GPano:FullPanoWidthPixels"),full_height:getAttr("GPano:FullPanoHeightPixels"),crop_width:getAttr("GPano:CroppedAreaImageWidthPixels"),crop_height:getAttr("GPano:CroppedAreaImageHeightPixels"),x:getAttr("GPano:CroppedAreaLeftPixels"),y:getAttr("GPano:CroppedAreaTopPixels")},console.log(self.exif),a()}))};